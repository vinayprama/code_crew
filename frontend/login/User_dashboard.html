<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Dashboard | Prama AI</title>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;700&display=swap" rel="stylesheet">
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase UMD Build -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: '#6366f1',
            secondary: '#f43f5e',
          },
          backgroundImage: {
            'animated': 'linear-gradient(-45deg, #e0eafc, #cfdef3, #e0eafc)',
          },
          animation: {
            gradient: 'gradientBG 10s ease infinite',
          },
          keyframes: {
            gradientBG: {
              '0%, 100%': { backgroundPosition: '0% 50%' },
              '50%': { backgroundPosition: '100% 50%' },
            },
          },
        }
      }
    };
  </script>
  <!-- Custom Styles -->
  <style>
    body { transition: background 0.5s, color 0.5s; font-family: 'Outfit', sans-serif; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #6366f1; border-radius: 4px; }
    .dark ::-webkit-scrollbar-thumb { background: #10b981; }
    @keyframes shimmer { 0% { background-position: -200px 0; } 100% { background-position: 200px 0; } }
    .shimmer {
      background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    .glass { backdrop-filter: blur(12px); background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255, 255, 255, 0.2); }
  </style>
</head>
<body class="flex h-screen overflow-hidden bg-animated bg-gradient-to-br from-white via-indigo-100 to-white dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 animate-gradient">
  <!-- Mobile Menu Button -->
  <button class="md:hidden absolute top-4 left-4 z-20 p-2 bg-white dark:bg-gray-800 rounded-md shadow" onclick="toggleSidebar()">‚ò∞</button>
  <!-- Sidebar -->
  <aside class="hidden md:flex w-64 bg-white dark:bg-gray-900 flex-col shadow-xl transition-all duration-300 ease-in-out border-r border-gray-200 dark:border-gray-700">
    <div class="p-6 flex items-center justify-between border-b border-gray-300 dark:border-gray-700">
      <h2 class="text-2xl font-bold tracking-wide text-gray-800 dark:text-white">Prama AI</h2>
      <button id="themeToggle" onclick="toggleTheme()" class="text-2xl">
        <span id="iconDark">üåô</span>
        <span id="iconLight" class="hidden">‚òÄÔ∏è</span>
      </button>
    </div>
    <nav class="flex-1 p-4 space-y-4">
      <button onclick="showSection('search')" class="w-full py-2 px-4 rounded-xl bg-gradient-to-r from-indigo-500 to-purple-500 hover:from-purple-500 hover:to-pink-500 text-white font-semibold shadow-lg neon-btn">+ New Chat</button>
      <button onclick="showSection('chat')" class="w-full py-2 px-4 rounded-xl bg-gradient-to-r from-green-500 to-teal-500 hover:from-teal-500 hover:to-cyan-500 text-white font-semibold shadow-lg neon-btn">Previous Chats</button>
      <button onclick="showSection('search')" class="w-full py-2 px-4 rounded-xl bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-orange-500 hover:to-red-500 text-white font-semibold shadow-lg neon-btn">Search Projects</button>
    </nav>
    <div class="p-4">
      <button id="start-voice" class="w-full py-2 px-4 rounded-xl bg-blue-500 hover:bg-blue-600 text-white font-semibold shadow-lg neon-btn">üéôÔ∏è Voice Mode</button>
      <button id="stop-voice" class="w-full py-2 px-4 rounded-xl bg-red-500 hover:bg-red-600 text-white font-semibold shadow-lg neon-btn hidden">‚ùå Close</button>
    </div>
    <div class="p-4 border-t border-gray-300 dark:border-gray-700">
      <div class="flex items-center space-x-3 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg shadow glass">
        <span id="usernameDisplay" class="font-medium text-gray-800 dark:text-white truncate">Loading...</span>
      </div>
      <button onclick="logout()" class="mt-4 w-full py-2 bg-red-500 hover:bg-red-600 rounded-lg text-white font-semibold shadow neon-btn">Logout</button>
    </div>
  </aside>
  <!-- Main Content -->
  <main class="flex-1 overflow-auto flex flex-col">
    <!-- Project Search & Upload -->
    <div id="search" class="flex-1 p-6 flex items-center justify-center">
      <div class="w-full max-w-lg glass p-8 rounded-3xl shadow-2xl backdrop-blur-md">
        <h1 class="text-3xl font-bold mb-4 text-center text-gray-900 dark:text-white">üîç Search or Upload Project</h1>
        <form id="projectForm" class="space-y-4">
          <input
            type="text" id="projectName" name="projectName" required placeholder="Project Name"
            class="w-full px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 focus:outline-none focus:ring-2 focus:ring-primary bg-white dark:bg-gray-700 text-black dark:text-white shadow-sm"
          />
          <button type="submit" class="w-full py-3 bg-indigo-600 hover:bg-indigo-700 rounded-xl text-white font-semibold shadow-lg neon-btn">
            üîç Search & Start
          </button>
        </form>
        <div class="my-4 text-center text-gray-500 dark:text-gray-300 font-semibold">OR</div>
        <div id="drop-area" class="p-6 border-2 border-dashed border-indigo-400 rounded-xl text-center cursor-pointer hover:bg-indigo-50 dark:hover:bg-gray-800">
          <p class="text-lg font-medium">üìÑ Drag & drop a DOCX to chat with it</p>
          <input type="file" id="fileElem" accept=".docx" style="display:none;" />
        </div>
      </div>
    </div>
    <!-- Chat Section -->
    <div id="chat" class="hidden flex-1 flex flex-col bg-white dark:bg-gray-800">
      <div class="flex-1 p-4 overflow-auto" id="chatWindow">
        <div class="text-center text-gray-500 dark:text-gray-400">Chatbot ready. Ask your questions!</div>
      </div>
      <div class="p-4 border-t border-gray-300 dark:border-gray-700 bg-gray-100 dark:bg-gray-900">
        <form id="chatForm" class="flex space-x-2">
          <input
            type="text" id="userInput" placeholder="Type your message..."
            class="flex-1 px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 focus:outline-none bg-white dark:bg-gray-700 text-black dark:text-white shadow"
          />
          <button type="submit" class="px-5 py-3 bg-indigo-600 hover:bg-indigo-700 rounded-xl text-white font-semibold shadow neon-btn">Send</button>
        </form>
      </div>
    </div>
  </main>
  <!-- Onboarding Modal -->
  <div id="onboarding" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-lg w-full shadow-xl relative">
      <h2 id="stepTitle" class="text-xl font-semibold mb-2 text-gray-900 dark:text-white"></h2>
      <p id="stepText" class="text-gray-700 dark:text-gray-300 mb-6"></p>
      <div class="flex justify-between">
        <button id="prevBtn" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-white rounded hover:bg-gray-300 dark:hover:bg-gray-600" disabled>Previous</button>
        <button id="nextBtn" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700">Next</button>
      </div>
      <button onclick="closeTour()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">&times;</button>
    </div>
  </div>
  <!-- Scripts -->
  <script>
    // Global variable for current project
    let currentProjectName = '';
    // Initialize Supabase client
    const supabaseUrl = 'https://dycssfukjwusfhrxwpgj.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5Y3NzZnVrand1c2Zocnh3cGdqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMwMTU0MTQsImV4cCI6MjA2ODU5MTQxNH0.WFIobEHLY9HyAuC8qWLtYoMPlOtpP6tdKEyjbvKVRzg';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);
    // Load username
    async function loadUsername() {
      try {
        const { data: sessionData, error: sessionError } = await supabaseClient.auth.getSession();
        if (sessionError || !sessionData.session) {
          console.warn('No active session:', sessionError);
          document.getElementById('usernameDisplay').textContent = "Guest";
          return;
        }
        const userEmail = sessionData.session.user.email;
        const { data, error } = await supabaseClient
          .from('auth_users')
          .select('name')
          .eq('email', userEmail)
          .single();
        if (error) {
          console.error("Error fetching name from auth_users:", error);
          document.getElementById('usernameDisplay').textContent = "User";
        } else {
          document.getElementById('usernameDisplay').textContent = data.name;
        }
      } catch (err) {
        console.error("Error loading username:", err);
        document.getElementById('usernameDisplay').textContent = "User";
      }
    }
    // Theme toggle
    if (localStorage.getItem('theme') === 'dark') {
      document.documentElement.classList.add('dark');
      document.getElementById('iconDark')?.classList.add('hidden');
      document.getElementById('iconLight')?.classList.remove('hidden');
    }
    function toggleTheme() {
      const html = document.documentElement;
      const isDark = html.classList.toggle('dark');
      document.getElementById('iconDark')?.classList.toggle('hidden', isDark);
      document.getElementById('iconLight')?.classList.toggle('hidden', !isDark);
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    // Sidebar toggle
    function toggleSidebar() {
      document.querySelector('aside')?.classList.toggle('hidden');
    }
    // Show section
    function showSection(sectionId) {
      console.log("Switching to section:", sectionId); // Debug
      document.getElementById('search').classList.add('hidden');
      document.getElementById('chat').classList.add('hidden');
      document.getElementById(sectionId).classList.remove('hidden');
    }
    // Project form submission
    document.getElementById('projectForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      const projectName = document.getElementById('projectName').value.trim();
      console.log("Project Name Submitted:", projectName); // Debug
      if (!projectName) {
        alert("Please enter a project name.");
        return;
      }
      currentProjectName = projectName;
      showSection('chat');
    });
    // Chat form submission
    document.getElementById('chatForm')?.addEventListener('submit', async e => {
      e.preventDefault();
      const msg = document.getElementById('userInput')?.value.trim();
      console.log("User Input:", msg, "Project Name:", currentProjectName); // Debug
      if (!msg || !currentProjectName) {
        alert("Please enter a message and ensure a project is selected.");
        return;
      }
      const chatWindow = document.getElementById('chatWindow');
      // User message display
      const userDiv = document.createElement('div');
      userDiv.textContent = msg;
      userDiv.className = 'text-right mb-2 text-gray-900 dark:text-white';
      chatWindow.appendChild(userDiv);
      // Loading shimmer
      const skeleton = document.createElement('div');
      skeleton.className = 'h-4 w-3/4 mb-2 rounded bg-gray-300 dark:bg-gray-700 animate-pulse shimmer';
      chatWindow.appendChild(skeleton);
      chatWindow.scrollTop = chatWindow.scrollHeight;
      document.getElementById('userInput').value = '';
      document.getElementById('userInput').focus();
      try {
        const res = await fetch("http://localhost:8001/chat/stream", {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ project_name: currentProjectName, query: msg })
        });
        if (!res.ok || !res.body) {
          const errorText = await res.text();
          throw new Error(errorText || 'Failed to get response from server');
        }
        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        chatWindow.removeChild(skeleton);
        const botDiv = document.createElement('div');
        botDiv.className = 'text-left mb-2 text-gray-700 dark:text-gray-300';
        chatWindow.appendChild(botDiv);
        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          botDiv.textContent += decoder.decode(value);
          chatWindow.scrollTop = chatWindow.scrollHeight;
        }
      } catch (err) {
        console.error("Chat error:", err);
        chatWindow.removeChild(skeleton);
        const errDiv = document.createElement('div');
        errDiv.textContent = '‚ö†Ô∏è Error: ' + err.message;
        errDiv.className = 'text-left mb-2 text-red-500';
        chatWindow.appendChild(errDiv);
      }
    });
    // Logout
    function logout() {
      localStorage.removeItem('token');
      window.location.href = 'auth.html';
    }
    // Drag & drop file upload
    const dropArea = document.getElementById('drop-area');
    dropArea?.addEventListener('dragover', e => {
      e.preventDefault();
      dropArea.classList.add('highlight');
    });
    dropArea?.addEventListener('dragleave', () => {
      dropArea.classList.remove('highlight');
    });
    dropArea?.addEventListener('drop', async e => {
      e.preventDefault();
      dropArea.classList.remove('highlight');
      const file = e.dataTransfer.files[0];
      if (file) await uploadFile(file);
    });
    async function uploadFile(file) {
      if (!file.name.endsWith('.docx')) {
        alert("Only .docx files are supported.");
        return;
      }
      const projectName = prompt("Enter project name:");
      if (!projectName) {
        alert("Project name is required.");
        return;
      }
      try {
        const checkRes = await fetch(`http://localhost:8001/upload/check_project/${projectName}`);
        const checkData = await checkRes.json();
        if (checkData.exists) {
          const proceed = confirm(`Project "${projectName}" already exists. Upload to this project?`);
          if (!proceed) return;
        }
        const formData = new FormData();
        formData.append("file", file);
        formData.append("project_name", projectName);
        formData.append("user_id", "vinayprama07_gmail.com");
        const res = await fetch("http://localhost:8001/upload_doc", {
          method: "POST",
          body: formData
        });
        const result = await res.json();
        if (res.ok) {
          alert("‚úÖ File uploaded successfully: " + result.message);
        } else {
          alert("‚ùå Upload failed: " + result.detail || "Unknown error");
        }
      } catch (err) {
        console.error("Upload error:", err);
        alert("‚ùå Upload failed.");
      }
    }
    // Voice mode
    const startBtn = document.getElementById('start-voice');
    const stopBtn = document.getElementById('stop-voice');
    const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = 'en-US';
    recognition.interimResults = false;
    recognition.continuous = true;
    startBtn.onclick = () => {
      recognition.start();
      startBtn.classList.add('hidden');
      stopBtn.classList.remove('hidden');
      console.log("üé§ Voice mode activated");
    };
    stopBtn.onclick = () => {
      recognition.stop();
      startBtn.classList.remove('hidden');
      stopBtn.classList.add('hidden');
      console.log("üõë Voice mode stopped");
    };
    recognition.onend = () => {
      if (!stopBtn.classList.contains('hidden')) {
        console.log("üîÑ Auto-restarting voice recognition");
        recognition.start();
      }
    };
    recognition.onerror = (event) => {
      console.error("Speech recognition error:", event.error);
    };
    recognition.onresult = async (event) => {
      const transcript = event.results[event.results.length - 1][0].transcript.trim();
      console.log("üó£Ô∏è You said:", transcript);
      try {
        const res = await fetch("http://localhost:8001/chat/voice", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: transcript,
            project_name: currentProjectName || "Smart Traffic AI",
            user_id: "vinayprama07_gmail.com"
          })
        });
        const data = await res.json();
        console.log("ü§ñ Bot replies:", data.reply);
        const utterance = new SpeechSynthesisUtterance(data.reply);
        utterance.lang = 'en-US';
        speechSynthesis.speak(utterance);
      } catch (err) {
        console.error("Fetch or TTS error:", err);
      }
    };
    // Onboarding tour
    const tourSteps = [
      { title: "üëã Welcome to Prama AI", text: "Welcome to Prama AI ‚Äî your intelligent project assistant!" },
      { title: "üîç Project Search Box", text: "Start by entering your project name here. We'll fetch the related documents from SharePoint securely.", highlight: "#projectName" },
      { title: "ü§ñ Smart Chatbot", text: "Ask anything related to your project! Our AI bot will read your SharePoint documents and give accurate answers.", highlight: "#chatWindow" },
      { title: "üòï Didn't get it?", text: "If you're ever confused or don‚Äôt understand the bot‚Äôs reply, just say so ‚Äî we‚Äôll schedule a live meeting with a team member." },
      { title: "üë• Team Collaboration", text: "You're not alone ‚Äî your team members are connected to the same project. We‚Äôll notify the right person when needed." },
      { title: "üõ°Ô∏è Safe & Secure", text: "All your data is stored safely with Supabase and document access is encrypted and controlled per project." },
      { title: "üéâ You're Ready!", text: "That‚Äôs it! You‚Äôre ready to explore Prama AI. Let‚Äôs make project management smarter.", final: true }
    ];
    let currentStep = 0;
    const onboardingEl = document.getElementById('onboarding');
    const stepTitle = document.getElementById('stepTitle');
    const stepText = document.getElementById('stepText');
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    function showTour() {
      onboardingEl?.classList.remove('hidden');
      loadStep(0);
    }
    function loadStep(i) {
      const step = tourSteps[i];
      stepTitle.textContent = step.title;
      stepText.textContent = step.text;
      prevBtn.disabled = i === 0;
      nextBtn.textContent = step.final ? 'Start Using Now' : 'Next';
      document.querySelectorAll('.ring-yellow-400').forEach(el =>
        el.classList.remove('ring', 'ring-yellow-400', 'ring-offset-2')
      );
      if (step.highlight) {
        document.querySelector(step.highlight)?.classList.add('ring', 'ring-yellow-400', 'ring-offset-2');
      }
    }
    nextBtn?.addEventListener('click', () => {
      if (currentStep < tourSteps.length - 1) {
        currentStep++;
        loadStep(currentStep);
      } else {
        closeTour();
      }
    });
    prevBtn?.addEventListener('click', () => {
      if (currentStep > 0) {
        currentStep--;
        loadStep(currentStep);
      }
    });
    function closeTour() {
      onboardingEl?.classList.add('hidden');
      document.querySelectorAll('.ring-yellow-400').forEach(el =>
        el.classList.remove('ring', 'ring-yellow-400', 'ring-offset-2')
      );
    }
    // Initialize on load
    window.addEventListener('load', () => {
      loadUsername();
      if (!localStorage.getItem('tourDone')) {
        showTour();
        localStorage.setItem('tourDone', true);
      }
    });
  </script>
</body>
</html>